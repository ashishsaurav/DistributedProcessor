<!DOCTYPE html>
<html>
<head>
    <title>Distributed Processor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .metrics-card {
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s;
        }

            .metrics-card:hover {
                transform: translateY(-5px);
            }

        .worker-online {
            background-color: #d1e7dd !important;
        }

        .worker-offline {
            background-color: #f8d7da !important;
        }

        .worker-busy {
            background-color: #fff3cd !important;
        }

        .log-entry {
            font-size: 0.85rem;
            padding: 8px;
            border-bottom: 1px solid #eee;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-badge {
            font-size: 0.85rem;
            padding: 0.35em 0.65em;
        }

        .card-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-tabs .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }

        .progress-animated {
            animation: progress-animation 1s ease-in-out;
        }

        @keyframes progress-animation {
            from {
                width: 0%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-cpu-fill"></i> Distributed Processor Dashboard
            </span>
            <span id="connectionStatus" class="badge bg-success">Connected</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Metrics Row - EXPANDED -->
        <div class="row mb-3">
            <!-- Workers Section -->
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-hdd-rack fs-2 text-primary"></i>
                        <h6 class="mt-2">Total Workers</h6>
                        <h2 id="totalWorkers">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle fs-2 text-success"></i>
                        <h6 class="mt-2">Idle Workers</h6>
                        <h2 id="idleWorkers">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-hourglass-split fs-2 text-warning"></i>
                        <h6 class="mt-2">Busy Workers</h6>
                        <h2 id="busyWorkers">0</h2>
                    </div>
                </div>
            </div>

            <!-- Collectors Section -->
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-database fs-2 text-info"></i>
                        <h6 class="mt-2">Total Collectors</h6>
                        <h2 id="totalCollectors">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle fs-2 text-success"></i>
                        <h6 class="mt-2">Idle Collectors</h6>
                        <h2 id="idleCollectors">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-down-circle fs-2 text-warning"></i>
                        <h6 class="mt-2">Busy Collectors</h6>
                        <h2 id="busyCollectors">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row - Jobs and Tasks -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-briefcase fs-2 text-info"></i>
                        <h6 class="mt-2">Total Jobs</h6>
                        <h2 id="totalJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-play-circle fs-2 text-primary"></i>
                        <h6 class="mt-2">Active Jobs</h6>
                        <h2 id="activeJobs">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-list-task fs-2 text-success"></i>
                        <h6 class="mt-2">Active Tasks</h6>
                        <h2 id="activeTasks">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-check-all fs-2 text-success"></i>
                        <h6 class="mt-2">Tasks Completed</h6>
                        <h2 id="tasksCompleted">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up fs-2 text-primary"></i>
                        <h6 class="mt-2">Tasks Processing</h6>
                        <h2 id="tasksProcessing">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card metrics-card">
                    <div class="card-body text-center">
                        <i class="bi bi-clock-history fs-2 text-secondary"></i>
                        <h6 class="mt-2">Tasks Pending</h6>
                        <h2 id="tasksPending">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Submission Card -->
        <div class="card mb-4">
            <div class="card-header card-header-custom">
                <h5><i class="bi bi-plus-circle"></i> Submit New Job</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label>Funds</label>
                        <div class="btn-group btn-group-sm mb-2 w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllFunds()">
                                <i class="bi bi-check-all"></i> All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFundSelection()">
                                <i class="bi bi-x"></i> Clear
                            </button>
                        </div>
                        <select id="fundSelect" class="form-select" multiple size="5">
                            <option disabled>Loading...</option>
                        </select>
                        <small class="text-muted">Selected: <strong id="selectedFundsDisplay">None</strong></small>
                    </div>

                    <div class="col-md-3">
                        <label>Start Date</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>

                    <div class="col-md-3">
                        <label>End Date</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>

                    <div class="col-md-3">
                        <label>&nbsp;</label>
                        <button onclick="submitJob()" class="btn btn-success w-100 btn-lg" id="submitBtn">
                            <i class="bi bi-play-fill"></i> Submit Job
                        </button>
                    </div>
                </div>
                <div id="message" class="mt-3"></div>
            </div>
        </div>

        <!-- Tabs for Workers, Collectors, Jobs, Tasks -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="workers-tab" data-bs-toggle="tab" data-bs-target="#workers" type="button">
                    <i class="bi bi-hdd-rack"></i> Workers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="collectors-tab" data-bs-toggle="tab" data-bs-target="#collectors" type="button">
                    <i class="bi bi-database"></i> Collectors
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button">
                    <i class="bi bi-briefcase"></i> Jobs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button">
                    <i class="bi bi-list-task"></i> Tasks
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">
                    <i class="bi bi-journal-text"></i> Event Log
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Workers Tab -->
            <div class="tab-pane fade show active" id="workers" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Worker ID</th>
                                        <th>Status</th>
                                        <th>Active Tasks</th>
                                        <th>CPU %</th>
                                        <th>Memory (MB)</th>
                                        <th>Last Heartbeat</th>
                                        <th>Total Processed</th>
                                    </tr>
                                </thead>
                                <tbody id="workersTableBody">
                                    <tr><td colspan="7" class="text-center text-muted">Loading workers...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collectors Tab -->
            <div class="tab-pane fade" id="collectors" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Collector ID</th>
                                        <th>Status</th>
                                        <th>Active Collections</th>
                                        <th>CPU %</th>
                                        <th>Memory (MB)</th>
                                        <th>Last Heartbeat</th>
                                        <th>Total Collected</th>
                                        <th>Avg Time (ms)</th>
                                    </tr>
                                </thead>
                                <tbody id="collectorsTableBody">
                                    <tr><td colspan="8" class="text-center text-muted">Loading collectors...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div class="tab-pane fade" id="jobs" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Job ID</th>
                                        <th>Fund(s)</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Completed/Total</th>
                                        <th>Pending</th>
                                        <th>Failed</th>
                                        <th>Rows Processed</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <tr><td colspan="8" class="text-center text-muted">No jobs submitted yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane fade" id="tasks" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Task ID</th>
                                        <th>Job ID</th>
                                        <th>Fund/Symbol</th>
                                        <th>Status</th>
                                        <th>Worker</th>
                                        <th>Rows</th>
                                        <th>Started</th>
                                        <th>Completed</th>
                                        <th>Duration</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTableBody">
                                    <tr><td colspan="9" class="text-center text-muted">No tasks created yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Log Tab -->
            <div class="tab-pane fade" id="logs" role="tabpanel">
                <div class="card">
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;" id="logContainer">
                        <p class="text-muted">Waiting for events...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000';
        const workersMap = new Map();
        const collectorsMap = new Map();
        let jobsData = [];
        let tasksData = [];

        // SignalR Connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl(`${API_URL}/hubs/monitoring`)
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // Real-time event handlers
        connection.on("JobsUpdate", function (jobs) {
            console.log("JobsUpdate received:", jobs);
            jobsData = jobs;
            updateJobsTable();
            updateMetrics();
        });

        connection.on("TasksUpdate", function (tasks) {
            console.log("TasksUpdate received:", tasks);
            tasksData = tasks;
            updateTasksTable();
            updateMetrics();
        });

        connection.on("WorkersUpdate", function (workers) {
            console.log("WorkersUpdate received:", workers);
            workers.forEach(w => workersMap.set(w.workerId, w));
            updateWorkersTable();
            updateMetrics();
        });

        connection.on("CollectorsUpdate", function (collectors) {
            console.log("CollectorsUpdate received:", collectors);
            collectors.forEach(c => collectorsMap.set(c.collectorId, c));
            updateCollectorsTable();
            updateMetrics();
        });

        connection.on("TaskStatusChanged", function (task) {
            console.log("TaskStatusChanged:", task);
            addLog(`Task ${task.taskId.substring(0, 8)} status: ${task.status}`, 'info');

            const index = tasksData.findIndex(t => t.taskId === task.taskId);
            if (index >= 0) {
                tasksData[index] = task;
            } else {
                tasksData.unshift(task);
            }
            updateTasksTable();
            updateMetrics();
        });

        connection.on("JobStatusChanged", function (job) {
            console.log("JobStatusChanged:", job);
            addLog(`Job ${job.jobId.substring(0, 8)} status: ${job.status} (${job.completedTasks}/${job.totalTasks})`, 'success');

            const index = jobsData.findIndex(j => j.jobId === job.jobId);
            if (index >= 0) {
                jobsData[index] = { ...jobsData[index], ...job };
            }
            updateJobsTable();
            updateMetrics();
        });

        // Start SignalR Connection
        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR Connected");
                document.getElementById('connectionStatus').className = 'badge bg-success';
                document.getElementById('connectionStatus').textContent = 'Connected';
                addLog("Dashboard connected - Real-time updates active", "success");
            } catch (err) {
                console.error("SignalR Connection Error:", err);
                document.getElementById('connectionStatus').className = 'badge bg-danger';
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                addLog("Connection failed, retrying...", "warning");
                setTimeout(startConnection, 5000);
            }
        }

        connection.onreconnecting(() => {
            document.getElementById('connectionStatus').className = 'badge bg-warning pulse';
            document.getElementById('connectionStatus').textContent = 'Reconnecting...';
            addLog("Reconnecting to dashboard...", "warning");
        });

        connection.onreconnected(() => {
            document.getElementById('connectionStatus').className = 'badge bg-success';
            document.getElementById('connectionStatus').textContent = 'Connected';
            addLog("Reconnected to dashboard", "success");
        });

        connection.onclose(() => {
            document.getElementById('connectionStatus').className = 'badge bg-danger';
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            addLog("Disconnected from dashboard", "danger");
            setTimeout(startConnection, 5000);
        });

        // Update Metrics - ENHANCED
        function updateMetrics() {
            const workers = Array.from(workersMap.values());
            const collectors = Array.from(collectorsMap.values());
            const now = Date.now();

            // Workers Metrics
            const onlineWorkers = workers.filter(w =>
                (now - new Date(w.lastHeartbeat).getTime()) < 30000
            );

            const totalWorkers = onlineWorkers.length;
            const idleWorkers = onlineWorkers.filter(w => w.state === 'Idle').length;
            const busyWorkers = onlineWorkers.filter(w => w.state === 'Busy').length;
            const totalActiveTasksOnWorkers = onlineWorkers.reduce((sum, w) => sum + (w.activeTasks || 0), 0);

            document.getElementById('totalWorkers').textContent = totalWorkers;
            document.getElementById('idleWorkers').textContent = idleWorkers;
            document.getElementById('busyWorkers').textContent = busyWorkers;

            // Collectors Metrics
            const onlineCollectors = collectors.filter(c =>
                (now - new Date(c.lastHeartbeat).getTime()) < 30000
            );

            const totalCollectors = onlineCollectors.length;
            const idleCollectors = onlineCollectors.filter(c => c.state === 'Idle').length;
            const busyCollectors = onlineCollectors.filter(c => c.state === 'Collecting').length;

            document.getElementById('totalCollectors').textContent = totalCollectors;
            document.getElementById('idleCollectors').textContent = idleCollectors;
            document.getElementById('busyCollectors').textContent = busyCollectors;

            // Jobs Metrics
            const totalJobs = jobsData.length;
            const activeJobs = jobsData.filter(j => j.status === 'Processing').length;

            document.getElementById('totalJobs').textContent = totalJobs;
            document.getElementById('activeJobs').textContent = activeJobs;

            // Tasks Metrics
            const pendingTasks = tasksData.filter(t => t.status === 'Pending').length;
            const processingTasks = tasksData.filter(t => t.status === 'Processing').length;
            const processedTasks = tasksData.filter(t => t.status === 'Processed').length;
            const completedTasks = tasksData.filter(t => t.status === 'Completed' || t.status === 'Collected').length;

            document.getElementById('activeTasks').textContent = totalActiveTasksOnWorkers;
            document.getElementById('tasksCompleted').textContent = completedTasks;
            document.getElementById('tasksProcessing').textContent = processingTasks + processedTasks;
            document.getElementById('tasksPending').textContent = pendingTasks;
        }

        // Update Jobs Table
        function updateJobsTable() {
            const tbody = document.getElementById('jobsTableBody');
            if (!tbody) return;

            if (jobsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No jobs submitted yet</td></tr>';
                return;
            }

            tbody.innerHTML = jobsData.map(job => {
                const progress = job.progressPercentage || 0;
                const statusBadge = getStatusBadge(job.status);
                const progressBar = getProgressBar(progress, job.status);

                return `
                        <tr>
                            <td><code>${job.jobId.substring(0, 8)}</code></td>
                            <td><strong>${job.fund}</strong></td>
                            <td>${statusBadge}</td>
                            <td>${progressBar}</td>
                            <td>${job.completedTasks}/${job.totalTasks}</td>
                            <td>${job.pendingTasks}</td>
                            <td>${job.failedTasks}</td>
                            <td>${job.processedRows.toLocaleString()}/${job.totalRows.toLocaleString()}</td>
                        </tr>
                    `;
            }).join('');
        }

        // Update Tasks Table
        function updateTasksTable() {
            const tbody = document.getElementById('tasksTableBody');
            if (!tbody) return;

            if (tasksData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No tasks created yet</td></tr>';
                return;
            }

            const recentTasks = tasksData.slice(0, 100);

            tbody.innerHTML = recentTasks.map(task => {
                const statusBadge = getTaskStatusBadge(task.status);
                const workerDisplay = task.workerId
                    ? `<small><code>${task.workerId.substring(0, 12)}</code></small>`
                    : '<span class="text-muted">-</span>';

                const completedTime = getCompletionTime(task);
                const durationDisplay = getTotalDuration(task);

                return `
                        <tr>
                            <td><code>${task.taskId.substring(0, 8)}</code></td>
                            <td><code>${task.jobId.substring(0, 8)}</code></td>
                            <td>${task.fund}/${task.symbol}</td>
                            <td>${statusBadge}</td>
                            <td>${workerDisplay}</td>
                            <td>${task.rowsProcessed || 0}</td>
                            <td><small>${formatTimestamp(task.startedAt)}</small></td>
                            <td><small>${completedTime}</small></td>
                            <td><small>${durationDisplay}</small></td>
                        </tr>
                    `;
            }).join('');
        }

        function getCompletionTime(task) {
            if (task.completedAt) {
                return formatTimestamp(task.completedAt);
            } else if (task.collectedAt) {
                return formatTimestamp(task.collectedAt) + ' 📦';
            } else if (task.processedAt) {
                return formatTimestamp(task.processedAt) + ' ✓';
            }
            return '-';
        }

        function getTotalDuration(task) {
            const processingMs = task.processingDurationMs || 0;
            const collectionMs = task.collectionDurationMs || 0;
            const totalMs = processingMs + collectionMs;

            if (totalMs === 0) return '-';

            if (processingMs > 0 && collectionMs > 0) {
                return `${totalMs}ms (P:${processingMs} + C:${collectionMs})`;
            } else if (processingMs > 0) {
                return `${processingMs}ms (processing)`;
            } else if (collectionMs > 0) {
                return `${collectionMs}ms (collection)`;
            }

            return `${totalMs}ms`;
        }

        // Update Workers Table
        function updateWorkersTable() {
            const tbody = document.getElementById('workersTableBody');
            if (!tbody) return;

            if (workersMap.size === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No workers connected</td></tr>';
                return;
            }

            const workers = Array.from(workersMap.values());

            workers.sort((a, b) => {
                if (a.state === 'Busy' && b.state !== 'Busy') return -1;
                if (a.state !== 'Busy' && b.state === 'Busy') return 1;
                return (b.activeTasks || 0) - (a.activeTasks || 0);
            });

            tbody.innerHTML = workers.map(worker => {
                const isOnline = (Date.now() - new Date(worker.lastHeartbeat).getTime()) < 30000;
                const statusBadge = worker.state === 'Busy'
                    ? '<span class="badge bg-warning">⚙️ Busy</span>'
                    : '<span class="badge bg-success">✓ Idle</span>';

                const onlineBadge = isOnline
                    ? '<span class="badge bg-success ms-1">Online</span>'
                    : '<span class="badge bg-danger ms-1">Offline</span>';

                const cpuScore = worker.cpuUsage || 0;
                const memoryScore = ((worker.memoryUsageMB || 0) / 4096.0) * 100;

                const tasksDisplay = worker.activeTasks > 0
                    ? `<span class="badge bg-primary">${worker.activeTasks} task${worker.activeTasks !== 1 ? 's' : ''}</span>`
                    : '<span class="text-muted">0</span>';

                return `
                        <tr class="${isOnline ? '' : 'table-secondary'}">
                            <td>
                                <code>${worker.workerId}</code>
                                ${onlineBadge}
                            </td>
                            <td>${statusBadge}</td>
                            <td>${tasksDisplay}</td>
                            <td>
                                <div class="progress" style="height: 20px; min-width: 80px;">
                                    <div class="progress-bar ${cpuScore > 80 ? 'bg-danger' : cpuScore > 50 ? 'bg-warning' : 'bg-success'}"
                                         role="progressbar"
                                         style="width: ${cpuScore}%">
                                        ${cpuScore.toFixed(1)}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px; min-width: 80px;">
                                    <div class="progress-bar bg-info"
                                         role="progressbar"
                                         style="width: ${memoryScore}%">
                                        ${worker.memoryUsageMB.toFixed(0)} MB
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small>${formatTimestamp(worker.lastHeartbeat)}</small>
                            </td>
                            <td>
                                <span class="badge bg-success">${worker.totalProcessed || 0}</span>
                            </td>
                        </tr>
                    `;
            }).join('');
        }

        // Update Collectors Table
        function updateCollectorsTable() {
            const tbody = document.getElementById('collectorsTableBody');
            if (!tbody) return;

            if (collectorsMap.size === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No collectors connected</td></tr>';
                return;
            }

            const collectors = Array.from(collectorsMap.values());

            collectors.sort((a, b) => {
                if (a.state === 'Collecting' && b.state !== 'Collecting') return -1;
                if (a.state !== 'Collecting' && b.state === 'Collecting') return 1;
                return (b.activeCollections || 0) - (a.activeCollections || 0);
            });

            tbody.innerHTML = collectors.map(collector => {
                const isOnline = (Date.now() - new Date(collector.lastHeartbeat).getTime()) < 30000;
                const statusBadge = collector.state === 'Collecting'
                    ? '<span class="badge bg-warning">📥 Collecting</span>'
                    : '<span class="badge bg-success">✓ Idle</span>';

                const onlineBadge = isOnline
                    ? '<span class="badge bg-success ms-1">Online</span>'
                    : '<span class="badge bg-danger ms-1">Offline</span>';

                const cpuScore = collector.cpuUsage || 0;
                const memoryScore = ((collector.memoryUsageMB || 0) / 4096.0) * 100;

                const collectionsDisplay = collector.activeCollections > 0
                    ? `<span class="badge bg-primary">${collector.activeCollections} active</span>`
                    : '<span class="text-muted">0</span>';

                return `
                        <tr class="${isOnline ? '' : 'table-secondary'}">
                            <td>
                                <code>${collector.collectorId}</code>
                                ${onlineBadge}
                            </td>
                            <td>${statusBadge}</td>
                            <td>${collectionsDisplay}</td>
                            <td>
                                <div class="progress" style="height: 20px; min-width: 80px;">
                                    <div class="progress-bar ${cpuScore > 80 ? 'bg-danger' : cpuScore > 50 ? 'bg-warning' : 'bg-success'}"
                                         role="progressbar"
                                         style="width: ${cpuScore}%">
                                        ${cpuScore.toFixed(1)}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px; min-width: 80px;">
                                    <div class="progress-bar bg-info"
                                         role="progressbar"
                                         style="width: ${memoryScore}%">
                                        ${collector.memoryUsageMB.toFixed(0)} MB
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small>${formatTimestamp(collector.lastHeartbeat)}</small>
                            </td>
                            <td>
                                <span class="badge bg-success">${collector.totalCollected || 0}</span>
                            </td>
                            <td>
                                <small>${collector.avgCollectionTimeMs || 0}ms</small>
                            </td>
                        </tr>
                    `;
            }).join('');
        }

        // Helper Functions
        function getStatusBadge(status) {
            const badges = {
                'Completed': '<span class="badge bg-success">✅ Completed</span>',
                'Processing': '<span class="badge bg-primary">⚙️ Processing</span>',
                'Pending': '<span class="badge bg-warning">⏳ Pending</span>',
                'Failed': '<span class="badge bg-danger">❌ Failed</span>',
                'Completed with Errors': '<span class="badge bg-warning">⚠️ Completed with Errors</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">❓ ${status}</span>`;
        }

        function getTaskStatusBadge(status) {
            const badges = {
                'Pending': '<span class="badge bg-secondary">⏳ Pending</span>',
                'Processing': '<span class="badge bg-primary">⚙️ Processing</span>',
                'Processed': '<span class="badge bg-info">✓ Processed</span>',
                'Collected': '<span class="badge bg-success">📦 Collected</span>',
                'Completed': '<span class="badge bg-success">✅ Completed</span>',
                'Failed': '<span class="badge bg-danger">❌ Failed</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">❓ ${status}</span>`;
        }

        function getProgressBar(progress, status) {
            let progressBarClass = 'bg-primary progress-animated';
            if (status === 'Completed') progressBarClass = 'bg-success';
            if (status === 'Failed' || status === 'Completed with Errors') progressBarClass = 'bg-danger';

            return `
                    <div class="progress">
                        <div class="progress-bar ${progressBarClass}"
                             role="progressbar"
                             style="width: ${progress}%"
                             aria-valuenow="${progress}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            ${progress}%
                        </div>
                    </div>
                `;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);

            if (diffSecs < 10) return 'Just now';
            if (diffSecs < 60) return `${diffSecs}s ago`;
            if (diffSecs < 3600) return `${Math.floor(diffSecs / 60)}m ago`;

            return date.toLocaleTimeString();
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer) {
                console.log(`[LOG ${type}]:`, message);
                return;
            }

            const timestamp = new Date().toLocaleTimeString();
            const alertClass = `alert-${type}`;
            const icon = type === 'success' ? '✅' : type === 'danger' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';

            const logEntry = document.createElement('div');
            logEntry.className = `alert ${alertClass} alert-dismissible fade show mb-2 log-entry`;
            logEntry.innerHTML = `
                    <small><strong>${timestamp}</strong></small> ${icon} ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

            logContainer.insertBefore(logEntry, logContainer.firstChild);

            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Submit Job Function
        async function submitJob() {
            const fundSelect = document.getElementById('fundSelect');
            const selectedFunds = Array.from(fundSelect.selectedOptions).map(opt => opt.value);
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const messageDiv = document.getElementById('message');
            const submitBtn = document.getElementById('submitBtn');

            if (selectedFunds.length === 0) {
                messageDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Please select at least one fund</div>';
                return;
            }

            if (!startDate || !endDate) {
                messageDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Please select date range</div>';
                return;
            }

            if (new Date(endDate) < new Date(startDate)) {
                messageDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> End date must be after start date</div>';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

            try {
                const response = await fetch(`${API_URL}/api/job/submit-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        funds: selectedFunds,
                        startDate: startDate,
                        endDate: endDate
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    const estimatedTime = result.estimatedCompletion ? new Date(result.estimatedCompletion).toLocaleTimeString() : 'N/A';

                    messageDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> <strong>Job Submitted Successfully!</strong>
                                <ul class="mb-0 mt-2">
                                    <li><strong>Job ID:</strong> <code>${result.jobId.substring(0, 8)}</code></li>
                                    <li><strong>Funds:</strong> ${result.fund}</li>
                                    <li><strong>Symbols:</strong> ${result.symbolsToProcess}</li>
                                    <li><strong>Total Rows:</strong> ${result.totalRows.toLocaleString()}</li>
                                    <li><strong>Est. Completion:</strong> ${estimatedTime}</li>
                                </ul>
                            </div>
                        `;

                    addLog(`Batch job submitted: ${result.jobId} for funds: ${result.fund}`, 'success');
                } else {
                    const errorData = await response.json();
                    messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${errorData.message || 'Job submission failed'}</div>`;
                    addLog('Job submission failed', 'danger');
                }
            } catch (err) {
                messageDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Error: ${err.message}</div>`;
                addLog(`Job submission failed: ${err.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-play-fill"></i> Submit Job';
            }
        }

        // Load Funds
        async function loadFunds() {
            const fundSelect = document.getElementById('fundSelect');

            try {
                fundSelect.innerHTML = '<option disabled>Loading...</option>';

                const response = await fetch(`${API_URL}/api/dashboard/funds`);

                if (!response.ok) {
                    throw new Error(`Failed to load funds: ${response.statusText}`);
                }

                const funds = await response.json();

                if (funds.length === 0) {
                    fundSelect.innerHTML = '<option disabled>No funds available</option>';
                    addLog('No funds found in database', 'warning');
                    return;
                }

                fundSelect.innerHTML = '';
                funds.forEach(fund => {
                    const option = document.createElement('option');
                    option.value = fund;
                    option.textContent = fund;
                    fundSelect.appendChild(option);
                });

                addLog(`Loaded ${funds.length} fund(s) from database`, 'success');

            } catch (err) {
                console.error('Error loading funds:', err);
                fundSelect.innerHTML = '<option disabled>Error loading funds</option>';
                addLog(`Failed to load funds: ${err.message}`, 'danger');
            }
        }

        function selectAllFunds() {
            const fundSelect = document.getElementById('fundSelect');
            for (let option of fundSelect.options) {
                if (!option.disabled) {
                    option.selected = true;
                }
            }
            updateFundDisplay();
        }

        function clearFundSelection() {
            const fundSelect = document.getElementById('fundSelect');
            for (let option of fundSelect.options) {
                option.selected = false;
            }
            updateFundDisplay();
        }

        function updateFundDisplay() {
            const fundSelect = document.getElementById('fundSelect');
            const selectedOptions = Array.from(fundSelect.selectedOptions)
                .filter(opt => !opt.disabled)
                .map(opt => opt.textContent);
            document.getElementById('selectedFundsDisplay').textContent =
                selectedOptions.length > 0 ? selectedOptions.join(', ') : 'None';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('endDate').valueAsDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            document.getElementById('startDate').valueAsDate = startDate;

            loadFunds();
            startConnection();

            document.getElementById('fundSelect').addEventListener('change', updateFundDisplay);
        });
    </script>

</body>
</html>
